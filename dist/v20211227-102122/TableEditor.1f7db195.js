import{r as ref,D as defineComponent,R as reactive,bv as remove,cc as minBy,cd as maxBy,a1 as nextTick,ce as parseInt,a2 as resolveComponent,F as openBlock,G as createElementBlock,v as createVNode,a9 as withCtx,K as createBaseVNode,u as unref,b0 as Popover,aJ as Input,aH as Button,aU as createTextVNode,L as toDisplayString,bH as DatePicker,ab as Fragment,ac as renderList,N as normalizeClass,ah as Tooltip,aj as mergeProps,m as cloneDeep,t as toRaw,cb as mergeWith}from"./vendor.2e1d877b.js";/* empty css               *//* empty css               */import{al as formatToDate,_ as _export_sfc,b as useI18n,I as Icon,h as useMessage}from"./index.86e9d70c.js";import{c as createTableConfigContext,u as useAddCol,a as useAddRow,b as useTimeStrFilter,d as useAreaSelect}from"./helper.3f416d3d.js";import{a as useModal}from"./index.f3cbd9f4.js";import _sfc_main$1 from"./CellSetting.19482bce.js";import{j as getSingleQuotaData}from"./index.b2a7a6f0.js";import"http://at.alicdn.com/t/font_2948274_sdqssf53jp.js";import"./onMountedOrActivated.9356963a.js";import"./useTimeout.534f4a33.js";import"./useWindowSizeFn.752f6aa7.js";import"./index.0fb85ddd.js";/* empty css              */import"./quotaEnum.42e6645f.js";var HeaderCellTypeEnum;(function(a){a[a.normal=0]="normal",a[a.date=1]="date"})(HeaderCellTypeEnum||(HeaderCellTypeEnum={}));var CellTypeEnum;(function(a){a[a.normal=0]="normal",a[a.quota=1]="quota",a[a.formula=2]="formula"})(CellTypeEnum||(CellTypeEnum={}));const tableConfigSchemaList=ref([{title:"",preview:"http://121.4.186.36:23588/cms/downloadFile?fileKey=files/table1.png",name:"\u6700\u65B0\u4E24\u671F\u5DEE\u503C",timeConfig:{endDate:formatToDate()},columns:[{title:"\u5206\u7C7B",field:"a",headerType:0,timeStr:""},{title:"\u6307\u6807\u540D\u79F0",field:"b",headerType:0,timeStr:""},{title:"\u524D\u503C",field:"c",headerType:1,timeStr:"-1"},{title:"\u6700\u65B0\u503C",field:"d",headerType:1,timeStr:"0"},{title:"\u53D8\u5316",field:"e",headerType:0,timeStr:""}],data:[{a:{val:"-",type:0},b:{val:"\u6307\u6807\u540D\u79F0",type:0},c:{val:"\u6307\u6807ID",type:1},d:{val:"\u6307\u6807ID",type:1},e:{val:"-",type:2}},{a:{val:"-",type:0},b:{val:"\u6307\u6807\u540D\u79F0",type:0},c:{val:"\u6307\u6807ID",type:1},d:{val:"\u6307\u6807ID",type:1},e:{val:"-",type:2}},{a:{val:"-",type:0},b:{val:"\u6307\u6807\u540D\u79F0",type:0},c:{val:"\u6307\u6807ID",type:1},d:{val:"\u6307\u6807ID",type:1},e:{val:"-",type:2}},{a:{val:"-",type:0},b:{val:"\u6307\u6807\u540D\u79F0",type:0},c:{val:"\u6307\u6807ID",type:1},d:{val:"\u6307\u6807ID",type:1},e:{val:"-",type:2}},{a:{val:"-",type:0},b:{val:"\u6307\u6807\u540D\u79F0",type:0},c:{val:"\u6307\u6807ID",type:1},d:{val:"\u6307\u6807ID",type:1},e:{val:"-",type:2}}]},{title:"",preview:"http://121.4.186.36:23588/cms/downloadFile?fileKey=files/table4.png",name:"\u7A7A\u767D5\u884C5\u5217",timeConfig:{endDate:formatToDate()},columns:[{title:"\u5217a",field:"a",headerType:0,timeStr:""},{title:"\u5217b",field:"b",headerType:0,timeStr:""},{title:"\u5217c",field:"c",headerType:0,timeStr:""},{title:"\u5217d",field:"d",headerType:0,timeStr:""},{title:"\u5217e",field:"e",headerType:0,timeStr:""}],data:[{a:{val:"-",type:0},b:{val:"-",type:0},c:{val:"-",type:0},d:{val:"-",type:0},e:{val:"-",type:0}},{a:{val:"-",type:0},b:{val:"-",type:0},c:{val:"-",type:0},d:{val:"-",type:0},e:{val:"-",type:0}},{a:{val:"-",type:0},b:{val:"-",type:0},c:{val:"-",type:0},d:{val:"-",type:0},e:{val:"-",type:0}},{a:{val:"-",type:0},b:{val:"-",type:0},c:{val:"-",type:0},d:{val:"-",type:0},e:{val:"-",type:0}},{a:{val:"-",type:0},b:{val:"-",type:0},c:{val:"-",type:0},d:{val:"-",type:0},e:{val:"-",type:0}}]}]);var TableEditor_vue_vue_type_style_index_0_scoped_true_lang="";const _hoisted_1={class:"p-4 bg-white"},_hoisted_2={class:"flex items-center gap-2"},_hoisted_3={class:"flex gap-1"},_hoisted_4={class:"flex items-center gap-1 cursor-pointer"},_hoisted_5={class:"flex flex-col items-center"},_hoisted_6={class:"flex gap-2"},_hoisted_7=["onClick"],_hoisted_8=["src"],_hoisted_9={class:"text-gray-400"},_hoisted_10={class:"flex items-center justify-center gap-1"},_hoisted_11={class:"text-gray-300"},_hoisted_12={class:"flex items-center justify-center"},_hoisted_13={class:"flex items-center w-auto gap-1 pl-1 border border-gray-300 header-icons-box"},_hoisted_14={class:"text-sm text-red-500"},_hoisted_15={class:"relative"},_hoisted_16={key:0,class:"select-none"},_hoisted_17={key:1,class:"flex items-center justify-center gap-1 select-none"},_hoisted_18={class:"absolute top-0 right-0 leading-4 text-gray-300 select-none"},_hoisted_19={class:"flex items-center justify-center"},_hoisted_20={class:"gap-1 pl-1 border-gray-300 header-icons-box"},_sfc_main=defineComponent({setup(__props){const[registerCellSettingModal,{openModal:openCellSettingModal,setModalProps:setCellSettingModalProps}]=useModal(),{t}=useI18n(),{createMessage}=useMessage(),xGrid=ref({}),gridOptions=reactive({border:!0,resizable:!0,align:"center",columns:[],toolbarConfig:{slots:{buttons:"toolbar-buttons"}},editConfig:{trigger:"click",mode:"cell",showIcon:!1},data:[],mergeCells:[],cellClassName:({rowIndex:a,columnIndex:e})=>selectedCells.value.find(n=>n.row===a&&n.col===e)?"area-cells":null,menuConfig:{body:{options:[[{code:"mergeCells",name:t("table.contextmenu.mergeCells"),disabled:!1},{code:"splitCells",name:t("table.contextmenu.splitCells"),disabled:!1},{code:"insertRowBefore",name:t("table.contextmenu.insertRowBefore"),disabled:!1},{code:"insertRowAfter",name:t("table.contextmenu.insertRowAfter"),disabled:!1},{code:"insertColLeft",name:t("table.contextmenu.insertColLeft"),disabled:!1},{code:"insertColRight",name:t("table.contextmenu.insertColRight"),disabled:!1},{code:"removeCol",name:t("table.contextmenu.removeCol"),disabled:!1},{code:"removeRow",name:t("table.contextmenu.removeRow"),disabled:!1}]]}},onCellMenu:({rowIndex:a,column:e})=>{const n=gridOptions.menuConfig.body.options[0],o={code:"updateCellData",name:t("table.contextmenu.updateCellData"),disabled:!1};n.find(l=>l.code===o.code)&&(remove(n,l=>l.code===o.code),tableConfig.data[a][e.property].type===CellTypeEnum.quota&&n.push(o))},onMenuClick:({menu:a,rowIndex:e,columnIndex:n,column:o,row:l})=>{var i,c;const r=xGrid.value;switch(a.code){case"mergeCells":const d=getAreaCells().value,g=minBy(d,s=>s.row).row,C=maxBy(d,s=>s.row).row,y=minBy(d,s=>s.col).col,v=maxBy(d,s=>s.col).col,u={row:minBy(d,s=>s.row).row,col:minBy(d,s=>s.col).col,rowspan:C-g+1,colspan:v-y+1};r.setMergeCells([u]);const p=(i=gridOptions.mergeCells)==null?void 0:i.find(s=>{s.col,u.col,s.row,u.row});p?(p.colspan=u.colspan,p.rowspan=u.rowspan):(c=gridOptions.mergeCells)==null||c.push(u);break;case"splitCells":r.removeMergeCells({row:e,col:n});break;case"updateCellData":getSingleData({rowIndex:e,columnIndex:n,column:o,row:l});break;case"insertRowBefore":addSpaceRow(e);break;case"insertRowAfter":const f=r.getMergeCells().find(s=>s.row===e&&s.rowspan>1),b=f?e+f.rowspan:e+1;addSpaceRow(b);break;case"insertColLeft":addCol(n);break;case"insertColRight":const m=r.getMergeCells().find(s=>s.row===n&&s.colspan>1),x=m?n+m.colspan:n+1;addCol(x);break;case"removeCol":removeCol(n);break;case"removeRow":removeRow(e);break}},onHeaderCellDblclick:async({column:a,$event:e})=>{const n=e.target.parentNode;a.slots.header="normal-title-text-editor",await nextTick(),n.querySelector("input").focus()},onEditClosed:updateCellData}),tableConfig=reactive({title:"",timeConfig:{endDate:formatToDate()},columns:[],mergeCells:[],data:[]});createTableConfigContext(tableConfig);const[colValue,{addCol,removeCol}]=useAddCol(xGrid,tableConfig),{addSpaceRow,removeRow}=useAddRow(xGrid,tableConfig),[timeStrTip,{timeStrFilter,vaildTimeStr}]=useTimeStrFilter(tableConfig),{getAreaCells}=useAreaSelect(xGrid,a=>{selectedCells.value=a}),selectedCells=ref([]);function closeTitleEditor({column:a,columnIndex:e}){var o;a.slots.header="normal-title-text";const n=tableConfig.columns[e];((o=n.timeStr)==null?void 0:o.trim().length)===0?(n.headerType,HeaderCellTypeEnum.normal):(n.headerType,HeaderCellTypeEnum.date),n.headerType===HeaderCellTypeEnum.date&&tableConfig.data.forEach(l=>{l[n.field].type=CellTypeEnum.quota,!isNaN(parseInt(l[n.field].val))})}function showCellModal({column:a,rowIndex:e,row:n,columnIndex:o}){openCellSettingModal(!0,{rowIndex:e,column:a}),setCellSettingModalProps({afterClose:updateCellData.bind(null,{column:a,rowIndex:e,row:n,columnIndex:o})})}function updateCellData({column:a,rowIndex:e,row:n,columnIndex:o}){const l=a.property;tableConfig.data[e][l].val=n[l],tableConfig.data[e][l].type!==CellTypeEnum.normal&&getSingleData({column:a,rowIndex:e,row:n,columnIndex:o})}async function getSingleData({row,column,rowIndex,columnIndex}){var a,e;const cell=tableConfig.data[rowIndex][column.property];if(cell.type===CellTypeEnum.formula){const str=row[column.property],exp=str.replace(/([a-z])(\d+)/g,function(n){const[o,l]=n.match(/([a-z]+)|(\d+)/g),r=tableConfig.data[l-1][o];return r.type===0?r.val:r.qData});cell.qData=eval(exp)}else if(cell.type===CellTypeEnum.quota){if(tableConfig.columns[columnIndex].headerType!==HeaderCellTypeEnum.date){createMessage.warn(t("table.headerCell.isNotDateTip"));return}const n=parseInt(row[column.property]);if(isNaN(n)||n.toString()!==row[column.property]){createMessage.warn(t("table.cell.idError"));return}const o=await getSingleQuotaData({id:n,date:timeStrFilter(tableConfig.columns[columnIndex].timeStr)});cell.qData=((e=(a=o[0])==null?void 0:a.data[0])!=null?e:[0,t("common.noData")])[1].toString()}}function titleChange(a,e){tableConfig.columns[a].title=e.target.value}function timeStrChange(a,e){tableConfig.columns[a].timeStr=e.target.value,tableConfig.columns[a].headerType=e.target.value.length>0?HeaderCellTypeEnum.date:HeaderCellTypeEnum.normal,vaildTimeStr(e)}function saveTable(){const e=xGrid.value.getMergeCells();tableConfig.mergeCells=cloneDeep(toRaw(e)),console.log(tableConfig)}const defaultTableConfig=ref({});function transfer(a){var n,o;const e={columns:[],data:[]};for(let l=0;l<a.columns.length;l++){const r=a.columns[l],i={field:r.field,title:r.title,editRender:{name:"input"},slots:{header:"normal-title-text",default:"normal-cell-text",edit:"normal-cell-text-editor"}};(n=e.columns)==null||n.push(i)}for(let l=0;l<a.data.length;l++){const r={},i=a.data[l];Object.keys(i).forEach(c=>{r[c]=i[c].val}),(o=e.data)==null||o.push(r)}return e}async function applyConfig(){gridOptions.columns=[],gridOptions.data=[],tableConfig.columns=[],tableConfig.data=[],mergeWith(gridOptions,cloneDeep(transfer(defaultTableConfig.value)),(a,e)=>{if(a instanceof Array)return reactive(e)}),mergeWith(tableConfig,cloneDeep(defaultTableConfig.value),(a,e)=>{if(a instanceof Array)return reactive(e)})}return(a,e)=>{const n=resolveComponent("VxeGrid");return openBlock(),createElementBlock("div",_hoisted_1,[createVNode(n,mergeProps(unref(gridOptions),{ref_key:"xGrid",ref:xGrid}),{"toolbar-buttons":withCtx(()=>[createBaseVNode("div",_hoisted_2,[createVNode(unref(Popover),{trigger:"click"},{content:withCtx(()=>[createBaseVNode("div",_hoisted_3,[createVNode(unref(Input),{size:"small",value:unref(colValue).title,"onUpdate:value":e[0]||(e[0]=o=>unref(colValue).title=o)},null,8,["value"]),createVNode(unref(Button),{size:"small",type:"primary",onClick:e[1]||(e[1]=o=>unref(addCol)(unref(tableConfig).columns.length))},{default:withCtx(()=>[createTextVNode(toDisplayString(unref(t)("common.okText")),1)]),_:1})])]),default:withCtx(()=>[createVNode(unref(Button),{size:"small"},{default:withCtx(()=>[createTextVNode(toDisplayString(unref(t)("table.addCol")),1)]),_:1})]),_:1}),createVNode(unref(Button),{size:"small",onClick:e[2]||(e[2]=o=>unref(addSpaceRow)(unref(tableConfig).data.length))},{default:withCtx(()=>[createTextVNode(toDisplayString(unref(t)("table.addRow")),1)]),_:1}),createVNode(unref(DatePicker),{size:"small",class:"!w-auto",value:unref(tableConfig).timeConfig.endDate,"onUpdate:value":e[3]||(e[3]=o=>unref(tableConfig).timeConfig.endDate=o),valueFormat:"YYYY-MM-DD"},{default:withCtx(()=>[createVNode(unref(Button),{class:"flex items-center gap-1",size:"small"},{default:withCtx(()=>[createBaseVNode("span",null,toDisplayString(unref(t)("table.endDate"))+"\uFF1A",1),createBaseVNode("span",_hoisted_4,[createBaseVNode("span",null,toDisplayString(unref(tableConfig).timeConfig.endDate),1),createVNode(unref(Icon),{class:"!text-primary",icon:"ant-design:field-time-outlined"})])]),_:1})]),_:1},8,["value"]),createVNode(unref(Button),{size:"small",type:"primary",onClick:saveTable},{default:withCtx(()=>[createTextVNode(toDisplayString(unref(t)("common.saveText")),1)]),_:1}),createVNode(unref(Popover),{trigger:"click"},{content:withCtx(()=>[createBaseVNode("div",_hoisted_5,[createBaseVNode("div",_hoisted_6,[(openBlock(!0),createElementBlock(Fragment,null,renderList(unref(tableConfigSchemaList),o=>(openBlock(),createElementBlock("div",{key:o.preview,class:normalizeClass(["flex flex-col items-center gap-2 border",defaultTableConfig.value.name===o.name?" border-primary":""]),onClick:l=>defaultTableConfig.value=o},[createBaseVNode("img",{class:"h-40 w-70",src:o.preview,alt:""},null,8,_hoisted_8),createBaseVNode("span",_hoisted_9,toDisplayString(o.name),1)],10,_hoisted_7))),128))]),createVNode(unref(Button),{size:"small",class:"mt-4 w-60",type:"primary",onClick:applyConfig},{default:withCtx(()=>[createTextVNode(toDisplayString(unref(t)("common.okText")),1)]),_:1})])]),default:withCtx(()=>[createVNode(unref(Button),{size:"small"},{default:withCtx(()=>[createTextVNode(toDisplayString(unref(t)("table.template")),1)]),_:1})]),_:1})])]),"normal-title-text":withCtx(({column:o,columnIndex:l})=>[createBaseVNode("div",_hoisted_10,[createBaseVNode("span",null,toDisplayString(o.title),1),createVNode(unref(Icon),{class:"ml-1 !text-primary",icon:["fluent:text-field-24-regular","ant-design:field-time-outlined"][unref(tableConfig).columns[l].headerType]},null,8,["icon"]),createBaseVNode("span",_hoisted_11,toDisplayString(o.property),1)])]),"normal-title-text-editor":withCtx(({column:o,columnIndex:l})=>[createBaseVNode("div",_hoisted_12,[createVNode(unref(Input),{class:"flex-grow text-center",size:"small",value:o.title,"onUpdate:value":r=>o.title=r,onBlur:r=>titleChange(l,r)},null,8,["value","onUpdate:value","onBlur"]),createBaseVNode("div",_hoisted_13,[createVNode(unref(Popover),{trigger:"click"},{content:withCtx(()=>[createVNode(unref(Input),{size:"small",class:"!w-34 !text-center",value:unref(tableConfig).columns[l].timeStr,"onUpdate:value":r=>unref(tableConfig).columns[l].timeStr=r,onInput:r=>timeStrChange(l,r)},{addonAfter:withCtx(()=>[createVNode(unref(Tooltip),null,{title:withCtx(()=>[createBaseVNode("span",null,toDisplayString(unref(t)("table.headerCell.timeStrTip")),1)]),default:withCtx(()=>[createVNode(unref(Icon),{icon:"ant-design:question-circle-outlined"})]),_:1})]),_:2},1032,["value","onUpdate:value","onInput"]),createBaseVNode("div",_hoisted_14,toDisplayString(unref(timeStrTip)),1)]),default:withCtx(()=>[createVNode(unref(Icon),{class:"cursor-pointer",icon:"ant-design:field-time-outlined"})]),_:2},1024),createVNode(unref(Icon),{class:"cursor-pointer",icon:"ant-design:check-outlined",onClick:r=>closeTitleEditor({column:o,columnIndex:l})},null,8,["onClick"])])])]),"normal-cell-text":withCtx(({row:o,column:l,rowIndex:r})=>[createBaseVNode("div",_hoisted_15,[unref(tableConfig).data[r][l.property].type===0?(openBlock(),createElementBlock("span",_hoisted_16,toDisplayString(o[l.property]),1)):(openBlock(),createElementBlock("span",_hoisted_17,[createBaseVNode("span",null,toDisplayString(unref(tableConfig).data[r][l.property].qData),1),createVNode(unref(Icon),{class:"!text-primary",icon:["tabler:letter-q","carbon:function-math"][unref(tableConfig).data[r][l.property].type-1]},null,8,["icon"])])),createBaseVNode("span",_hoisted_18,toDisplayString(r+1),1)])]),"normal-cell-text-editor":withCtx(({row:o,column:l,rowIndex:r,columnIndex:i})=>[createBaseVNode("div",_hoisted_19,[createVNode(unref(Input),{class:"text-center",value:o[l.property],"onUpdate:value":c=>o[l.property]=c},null,8,["value","onUpdate:value"]),createBaseVNode("div",_hoisted_20,[createVNode(unref(Icon),{icon:"ant-design:setting-outlined",onClick:c=>showCellModal({column:l,rowIndex:r,row:o,columnIndex:i})},null,8,["onClick"])])])]),_:1},16),createVNode(_sfc_main$1,{onRegister:unref(registerCellSettingModal)},null,8,["onRegister"])])}}});var TableEditor=_export_sfc(_sfc_main,[["__scopeId","data-v-fb9a0210"]]);export{TableEditor as default};
